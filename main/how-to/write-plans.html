
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Writing Bluesky plans for Blueapi &#8212; blueapi 0.6.1a6.dev1+ge51530c5 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=4cd8a1b4"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'how-to/write-plans';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://DiamondLightSource.github.io/blueapi/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/blueapi-logo.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Explanations" href="../explanations.html" />
    <link rel="prev" title="Run in a container" href="run-container.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/blueapi-logo.svg" class="logo__image only-light" alt=""/>
    <img src="../_static/blueapi-logo.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">blueapi</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/blueapi" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/blueapi" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/blueapi" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/blueapi" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="add-plans-and-devices.html">Add Plans and Devices to your Blueapi Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure-app.html">Configure the application</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Contribute to the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="run-cli.html">Control the Worker via the CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="run-container.html">Run in a container</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Writing Bluesky plans for Blueapi</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../how-to.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Writing Bluesky plans for Blueapi</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="writing-bluesky-plans-for-blueapi">
<h1>Writing Bluesky plans for Blueapi<a class="headerlink" href="#writing-bluesky-plans-for-blueapi" title="Link to this heading">#</a></h1>
<p>For an introduction to bluesky plans and general forms/advice, <code class="docutils literal notranslate"><span class="pre">see</span> <span class="pre">the</span> <span class="pre">bluesky</span> <span class="pre">documentation</span> <span class="pre">&lt;https://nsls-ii.github.io/bluesky/plans.html&gt;</span></code>__. Blueapi has some additional requirements, which are explained below.</p>
<section id="plans">
<h2>Plans<a class="headerlink" href="#plans" title="Link to this heading">#</a></h2>
<p>While the bluesky project uses <code class="docutils literal notranslate"><span class="pre">plan</span></code> in a general sense to refer to any <code class="docutils literal notranslate"><span class="pre">Iterable</span></code> of <code class="docutils literal notranslate"><span class="pre">Msg</span></code>\ s which may be run by the <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code>, blueapi distinguishes between a <code class="docutils literal notranslate"><span class="pre">plan</span></code> and a <code class="docutils literal notranslate"><span class="pre">stub</span></code>. This distinction is made to allow for a subset of <code class="docutils literal notranslate"><span class="pre">stub</span></code>\ s to be exposed and run, as <code class="docutils literal notranslate"><span class="pre">stub</span></code>\ s may not make sense to run alone.</p>
<p>Generally, a <code class="docutils literal notranslate"><span class="pre">plan</span></code> includes at least one <code class="docutils literal notranslate"><span class="pre">open_run</span></code> and <code class="docutils literal notranslate"><span class="pre">close_run</span></code> and is a complete description of an experiment. If it does not, it is a <code class="docutils literal notranslate"><span class="pre">stub</span></code>. This distinction is made in the bluesky core library between the <code class="docutils literal notranslate"><span class="pre">plan</span></code>\ s and <code class="docutils literal notranslate"><span class="pre">plan_stub</span></code>\ s modules.</p>
</section>
<section id="type-annotations">
<h2>Type Annotations<a class="headerlink" href="#type-annotations" title="Link to this heading">#</a></h2>
<p>To be imported into the blueapi context, <code class="docutils literal notranslate"><span class="pre">plan</span></code>\ s and <code class="docutils literal notranslate"><span class="pre">stub</span></code>\ s must be the in the form of a <code class="docutils literal notranslate"><span class="pre">PlanGenerator</span></code>: any function that return a <code class="docutils literal notranslate"><span class="pre">MsgGenerator</span></code> (a python <code class="docutils literal notranslate"><span class="pre">Generator</span></code> that yields <code class="docutils literal notranslate"><span class="pre">Msg</span></code>\ s). <code class="docutils literal notranslate"><span class="pre">PlanGenerator</span></code> and <code class="docutils literal notranslate"><span class="pre">MsgGenerator</span></code> types are available to import from <code class="docutils literal notranslate"><span class="pre">dodal</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="k">def</span> <span class="nf">foo</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">MsgGenerator</span><span class="p">:</span>
       <span class="c1"># The minimum PlanGenerator acceptable to blueapi</span>
       <span class="k">yield from</span> <span class="p">{}</span>
</pre></div>
</div>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> <code class="docutils literal notranslate"><span class="pre">PlanGenerator</span></code> arguments must be annotated to enable blueapi to generate their schema</p>
</div></blockquote>
<p><strong>Input annotations should be as broad as possible</strong>, the least specific implementation that is sufficient to accomplish the requirements of the plan.</p>
<p>For example, if a plan is written to drive a specific implementation of Movable, but never calls any methods on the device and only yields bluesky <code class="docutils literal notranslate"><span class="pre">'set'</span></code> Msgs, it can be generalised to instead use the base protocol <code class="docutils literal notranslate"><span class="pre">Movable</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="k">def</span> <span class="nf">move_to_each_position</span><span class="p">(</span><span class="n">axis</span><span class="p">:</span> <span class="n">Movable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MsgGenerator</span><span class="p">:</span>
       <span class="c1"># Originally written for SpecificImplementationMovable</span>
       <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
           <span class="k">yield from</span> <span class="n">abs_set</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="allowed-argument-types">
<h2>Allowed Argument Types<a class="headerlink" href="#allowed-argument-types" title="Link to this heading">#</a></h2>
<p>When added to the blueapi context, <code class="docutils literal notranslate"><span class="pre">PlanGenerator</span></code>\ s are formalised into their schema- <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">Pydantic</span> <span class="pre">BaseModel</span> <span class="pre">&lt;https://docs.pydantic.dev/1.10/usage/models/&gt;</span></code>__ with the expected argument types and their defaults.</p>
<p>Therefore, <code class="docutils literal notranslate"><span class="pre">PlanGenerator</span></code>\ s must only take as arguments <code class="docutils literal notranslate"><span class="pre">those</span> <span class="pre">types</span> <span class="pre">which</span> <span class="pre">are</span> <span class="pre">valid</span> <span class="pre">Pydantic</span> <span class="pre">fields</span> <span class="pre">&lt;https://docs.pydantic.dev/dev/concepts/types/&gt;</span></code>__ or Device types which implement <code class="docutils literal notranslate"><span class="pre">BLUESKY_PROTOCOLS</span></code> defined in dodal, which are fetched from the context at runtime.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Allowed argument types for Pydantic BaseModels include the primitives, types that extend `BaseModel` and `dict`\ s, `list`\ s  and other `sequence`\ s of supported types. Blueapi will deserialise these types from JSON, so `dict`\ s should use `str` keys.
</pre></div>
</div>
</section>
<section id="injecting-defaults">
<h2>Injecting defaults<a class="headerlink" href="#injecting-defaults" title="Link to this heading">#</a></h2>
<p>Often when writing a plan, it is known which device the plan will mostly or always be run with, but at the time of writing the plan the device object has not been instantiated: dodal defines device factory functions, but these cannot be injected as default arguments to plans.</p>
<p>Dodal defines an <code class="docutils literal notranslate"><span class="pre">inject</span></code> function which bypasses the type checking of the constructed schemas, defering to the blueapi contexting fetching of the device when the plan is imported. This allows defaulting devices, so long as there is a device of that name in the context which conforms to the type annotation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="k">def</span> <span class="nf">touch_synchrotron</span><span class="p">(</span><span class="n">sync</span><span class="p">:</span> <span class="n">Synchrotron</span> <span class="o">=</span> <span class="n">inject</span><span class="p">(</span><span class="s2">&quot;synchrotron&quot;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">MsgGenerator</span><span class="p">:</span>
       <span class="c1"># There is only one Synchrotron device, so we know which one it will always be.</span>
       <span class="c1"># If there is no device named &quot;synchrotron&quot; in the blueapi context, it will except.</span>
       <span class="n">sync</span><span class="o">.</span><span class="n">specific_function</span><span class="p">()</span>
       <span class="k">yield from</span> <span class="p">{}</span>
</pre></div>
</div>
<section id="metadata">
<h3>Metadata<a class="headerlink" href="#metadata" title="Link to this heading">#</a></h3>
<p>The bluesky event model allows for rich structured metadata to be attached to a scan. To enable this to be used consistently, blueapi encourages a standard form.</p>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> Plans <strong>should</strong> include <code class="docutils literal notranslate"><span class="pre">metadata</span></code> as their final argument, if they do it <strong>must</strong> have the type Optional[Mapping[str, Any]], <code class="docutils literal notranslate"><span class="pre">and</span> <span class="pre">a</span> <span class="pre">default</span> <span class="pre">of</span> <span class="pre">None</span> <span class="pre">&lt;https://stackoverflow.com/questions/26320899/why-is-the-empty-dictionary-a-dangerous-default-value-in-python&gt;</span></code>__, with the plan defaulting to an empty dict if passed <code class="docutils literal notranslate"><span class="pre">None</span></code>. If the plan calls to a stub/plan which takes metadata, the plan <strong>must</strong> pass down its metadata, which may be a differently named argument.</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="k">def</span> <span class="nf">pass_metadata</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Movable</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MsgGenerator</span><span class="p">:</span>
       <span class="k">yield from</span> <span class="n">bp</span><span class="o">.</span><span class="n">count</span><span class="p">{[</span><span class="n">x</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}}</span>
</pre></div>
</div>
</section>
</section>
<section id="docstrings">
<h2>Docstrings<a class="headerlink" href="#docstrings" title="Link to this heading">#</a></h2>
<p>Blueapi plan schemas include includes the docstrings of imported Plans. <strong>These should therefore explain as much about the scan as cannot be ascertained from its arguments and name</strong>. This may include units of arguments (e.g. seconds or microseconds), its purpose in the function, the purpose of the plan etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="k">def</span> <span class="nf">temp_pressure_snapshot</span><span class="p">(</span>
       <span class="n">detectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Readable</span><span class="p">],</span>
       <span class="n">temperature</span><span class="p">:</span> <span class="n">Movable</span> <span class="o">=</span> <span class="n">inject</span><span class="p">(</span><span class="s2">&quot;sample_temperature&quot;</span><span class="p">),</span>
       <span class="n">pressure</span><span class="p">:</span> <span class="n">Movable</span> <span class="o">=</span> <span class="n">inject</span><span class="p">(</span><span class="s2">&quot;sample_pressure&quot;</span><span class="p">),</span>
       <span class="n">target_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">273.0</span><span class="p">,</span>
       <span class="n">target_pressure</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span>
       <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MsgGenerator</span><span class="p">:</span>
<span class="w">       </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Moves devices for pressure and temperature (defaults fetched from the context)</span>
<span class="sd">       and captures a single frame from a collection of devices</span>
<span class="sd">       Args:</span>
<span class="sd">           detectors (List[Readable]): A list of devices to read while the sample is at STP</span>
<span class="sd">           temperature (Optional[Movable]): A device controlling temperature of the sample,</span>
<span class="sd">               defaults to fetching a device name &quot;sample_temperature&quot; from the context</span>
<span class="sd">           pressure (Optional[Movable]): A device controlling pressure on the sample,</span>
<span class="sd">               defaults to fetching a device name &quot;sample_pressure&quot; from the context</span>
<span class="sd">           target_pressure (Optional[float]): target temperature in Kelvin. Default 273</span>
<span class="sd">           target_pressure (Optional[float]): target pressure in Pa. Default 10**5</span>
<span class="sd">       Returns:</span>
<span class="sd">           MsgGenerator: Plan</span>
<span class="sd">       Yields:</span>
<span class="sd">           Iterator[MsgGenerator]: Bluesky messages</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">yield from</span> <span class="n">move</span><span class="p">({</span><span class="n">temperature</span><span class="p">:</span> <span class="n">target_temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">:</span> <span class="n">target_pressure</span><span class="p">})</span>
       <span class="k">yield from</span> <span class="n">count</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span>
</pre></div>
</div>
<section id="decorators">
<h3>Decorators<a class="headerlink" href="#decorators" title="Link to this heading">#</a></h3>
<p>Dodal defines a decorator for configuring any <code class="docutils literal notranslate"><span class="pre">ophyd-async</span></code> devices- which will be the majority of devices at Diamond- to write to a common location.</p>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> <strong>This is an absolute requirement to write data onto the Diamond Filesystem</strong>.  This decorator must be used every time a new data collection is intended to begin. For an example, see below.</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="nd">@attach_metadata</span>
   <span class="k">def</span> <span class="nf">ophyd_async_snapshot</span><span class="p">(</span>
       <span class="n">detectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Readable</span><span class="p">],</span>
       <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="c1">###    ) -&gt; MsgGenerator:</span>
       <span class="n">Configures</span> <span class="n">a</span> <span class="n">number</span> <span class="n">of</span> <span class="n">devices</span><span class="p">,</span> <span class="n">which</span> <span class="n">may</span> <span class="n">be</span> <span class="n">Ophyd</span><span class="o">-</span><span class="n">Async</span> <span class="n">detectors</span> <span class="ow">and</span> <span class="n">require</span>
       <span class="n">knowledge</span> <span class="n">of</span> <span class="n">where</span> <span class="n">to</span> <span class="n">write</span> <span class="n">their</span> <span class="n">files</span><span class="p">,</span> <span class="n">then</span> <span class="n">takes</span> <span class="n">a</span> <span class="n">snapshot</span> <span class="k">with</span> <span class="n">them</span><span class="o">.</span>
       <span class="n">Args</span><span class="p">:</span>
           <span class="n">detectors</span> <span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Readable</span><span class="p">]):</span> <span class="n">Devices</span><span class="p">,</span> <span class="n">maybe</span> <span class="n">including</span> <span class="n">Ophyd</span><span class="o">-</span><span class="n">Async</span> <span class="n">detectors</span><span class="o">.</span>
       <span class="n">Returns</span><span class="p">:</span>
           <span class="n">MsgGenerator</span><span class="p">:</span> <span class="n">Plan</span>
       <span class="n">Yields</span><span class="p">:</span>
<span class="c1">###            Iterator[MsgGenerator]: Bluesky messages</span>
       <span class="k">yield from</span> <span class="n">count</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span>

   <span class="k">def</span> <span class="nf">repeated_snapshot</span><span class="p">(</span>
       <span class="n">detectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Readable</span><span class="p">],</span>
       <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="c1">###    ) -&gt; MsgGenerator:</span>
       <span class="n">Configures</span> <span class="n">a</span> <span class="n">number</span> <span class="n">of</span> <span class="n">devices</span><span class="p">,</span> <span class="n">which</span> <span class="n">may</span> <span class="n">be</span> <span class="n">Ophyd</span><span class="o">-</span><span class="n">Async</span> <span class="n">detectors</span> <span class="ow">and</span> <span class="n">require</span>
       <span class="n">knowledge</span> <span class="n">of</span> <span class="n">where</span> <span class="n">to</span> <span class="n">write</span> <span class="n">their</span> <span class="n">files</span><span class="p">,</span> <span class="n">then</span> <span class="n">takes</span> <span class="n">multiple</span> <span class="n">snapshot</span> <span class="k">with</span> <span class="n">them</span><span class="o">.</span>
       <span class="n">Args</span><span class="p">:</span>
           <span class="n">detectors</span> <span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Readable</span><span class="p">]):</span> <span class="n">Devices</span><span class="p">,</span> <span class="n">maybe</span> <span class="n">including</span> <span class="n">Ophyd</span><span class="o">-</span><span class="n">Async</span> <span class="n">detectors</span><span class="o">.</span>
       <span class="n">Returns</span><span class="p">:</span>
           <span class="n">MsgGenerator</span><span class="p">:</span> <span class="n">Plan</span>
       <span class="n">Yields</span><span class="p">:</span>
<span class="c1">###            Iterator[MsgGenerator]: Bluesky messages</span>
       <span class="nd">@attach_metadata</span>
       <span class="k">def</span> <span class="nf">inner_function</span><span class="p">():</span>
           <span class="k">yield from</span> <span class="n">count</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span>


       <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
           <span class="k">yield from</span> <span class="n">inner_function</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="stubs">
<h3>Stubs<a class="headerlink" href="#stubs" title="Link to this heading">#</a></h3>
<p>Some functionality in your plans may make sense to factor out to allow re-use. These pieces of functionality may or may not make sense outside of the context of a plan. Some will, such as nudging a motor, but others may not, such as waiting to consume data from the previous position, or opening a run without an equivalent closure.</p>
<p>To enable blueapi to expose the stubs that it makes sense to, but not the others, blueapi will only expose a subset of <code class="docutils literal notranslate"><span class="pre">MsgGenerator</span></code>\ s under the following conditions:</p>
<p>| <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> in directory has <code class="docutils literal notranslate"><span class="pre">__exports__</span></code>: List[str]: only
those named in <code class="docutils literal notranslate"><span class="pre">__exports__</span></code>
| <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> in directory has <code class="docutils literal notranslate"><span class="pre">__all__</span></code>: List[str] but no
<code class="docutils literal notranslate"><span class="pre">__exports__</span></code>: only those named in <code class="docutils literal notranslate"><span class="pre">__all__</span></code></p>
<p>This allows other python packages (such as <code class="docutils literal notranslate"><span class="pre">plans</span></code>) to access every function in <code class="docutils literal notranslate"><span class="pre">__all__</span></code>, while only allowing a subset to be called from blueapi as standalone.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Rehomes all of the beamline&#39;s devices. May require to be run standalone</span>
    <span class="kn">from</span> <span class="nn">.package</span> <span class="kn">import</span> <span class="n">rehome_devices</span>
    <span class="c1"># Awaits a standard callback from analysis. Should not be run standalone</span>
    <span class="kn">from</span> <span class="nn">.package</span> <span class="kn">import</span> <span class="n">await_callback</span>

    <span class="c1"># Exported from the module for use by other modules</span>
    <span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;rehome_devices&quot;</span><span class="p">,</span>
        <span class="s2">&quot;await_callback&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Imported by instances of blueapi and allowed to be run</span>
    <span class="n">__exports__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;rehome_devices&quot;</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="run-container.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Run in a container</p>
      </div>
    </a>
    <a class="right-next"
       href="../explanations.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Explanations</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plans">Plans</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#type-annotations">Type Annotations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allowed-argument-types">Allowed Argument Types</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#injecting-defaults">Injecting defaults</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metadata">Metadata</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#docstrings">Docstrings</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decorators">Decorators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stubs">Stubs</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/DiamondLightSource/blueapi/edit/main/docs/how-to/write-plans.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/how-to/write-plans.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>